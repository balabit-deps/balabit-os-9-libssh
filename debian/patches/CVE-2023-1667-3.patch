Backport of:

From abcf9699aadf93eec8a580df7ef32f91a0e21de2 Mon Sep 17 00:00:00 2001
From: Jakub Jelen <jjelen@redhat.com>
Date: Mon, 13 Mar 2023 15:11:25 +0100
Subject: CVE-2023-1667:kex: Remove needless function argument

The information if the session is client or server session is already part of
the session structure so this argument only duplicated information.

Signed-off-by: Jakub Jelen <jjelen@redhat.com>
Reviewed-by: Norbert Pocs <npocs@redhat.com>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
---
 include/libssh/kex.h | 2 +-
 src/client.c         | 4 ++--
 src/kex.c            | 6 +++---
 src/server.c         | 4 ++--
 4 files changed, 8 insertions(+), 8 deletions(-)

--- a/include/libssh/kex.h
+++ b/include/libssh/kex.h
@@ -33,7 +33,7 @@ struct ssh_kex_struct {
 
 SSH_PACKET_CALLBACK(ssh_packet_kexinit);
 
-int ssh_send_kex(ssh_session session, int server_kex);
+int ssh_send_kex(ssh_session session);
 void ssh_list_kex(struct ssh_kex_struct *kex);
 int ssh_set_client_kex(ssh_session session);
 int ssh_kex_select_methods(ssh_session session);
--- a/src/client.c
+++ b/src/client.c
@@ -420,7 +420,7 @@ static void ssh_client_connection_callba
             if (rc != SSH_OK) {
                 goto error;
             }
-            rc = ssh_send_kex(session, 0);
+            rc = ssh_send_kex(session);
             if (rc < 0) {
                 goto error;
             }
@@ -439,7 +439,7 @@ static void ssh_client_connection_callba
                 if (rc != SSH_OK) {
                     goto error;
                 }
-                rc = ssh_send_kex(session, 0);
+                rc = ssh_send_kex(session);
                 if (rc < 0) {
                     goto error;
                 }
--- a/src/kex.c
+++ b/src/kex.c
@@ -830,9 +830,9 @@ int ssh_kex_select_methods (ssh_session
 
 
 /* this function only sends the predefined set of kex methods */
-int ssh_send_kex(ssh_session session, int server_kex)
+int ssh_send_kex(ssh_session session)
 {
-  struct ssh_kex_struct *kex = (server_kex ? &session->next_crypto->server_kex :
+  struct ssh_kex_struct *kex = (session->server ? &session->next_crypto->server_kex :
       &session->next_crypto->client_kex);
   ssh_string str = NULL;
   int i;
@@ -929,7 +929,7 @@ int ssh_send_rekex(ssh_session session)
     }
 
     session->dh_handshake_state = DH_STATE_INIT;
-    rc = ssh_send_kex(session, session->server);
+    rc = ssh_send_kex(session);
     if (rc < 0) {
         SSH_LOG(SSH_LOG_PACKET, "Failed to send kex");
         return rc;
--- a/src/server.c
+++ b/src/server.c
@@ -367,7 +367,7 @@ static void ssh_server_connection_callba
             ssh_packet_set_default_callbacks(session);
             set_status(session, 0.5f);
             session->session_state=SSH_SESSION_STATE_INITIAL_KEX;
-            if (ssh_send_kex(session, 1) < 0) {
+            if (ssh_send_kex(session) < 0) {
                 goto error;
             }
             break;
@@ -380,7 +380,7 @@ static void ssh_server_connection_callba
                 if(server_set_kex(session) == SSH_ERROR)
                     goto error;
                 /* We are in a rekeying, so we need to send the server kex */
-                if(ssh_send_kex(session, 1) < 0)
+                if(ssh_send_kex(session) < 0)
                     goto error;
             }
             ssh_list_kex(&session->next_crypto->client_kex); // log client kex
